<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소식지 편집</title>
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        .valid-link::after {
            content: '✅';
            color: green;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <ul>
            <li><a href="admin-dashboard.html">대시보드</a></li>
            <li><a href="admin-newsletters.html">소식지 관리</a></li>
            <li><a href="admin-settings.html">설정</a></li>
            <li><a href="#" onclick="logout()">로그아웃</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1>소식지 편집</h1>
        <form id="newsletterForm">
            <div class="form-group">
                <label for="year">년도:</label>
                <input type="number" id="year" name="year" required>
            </div>
            <div class="form-group">
                <label for="month">월:</label>
                <input type="number" id="month" name="month" min="1" max="12" required>
            </div>
            <div class="form-group">
                <label for="title">제목:</label>
                <input type="text" id="title" name="title" required>
            </div>
            <div id="imageLinks">
                <h3>사진 링크 (최대 10개)</h3>
            </div>
            <button type="button" onclick="addImageLink()" class="btn btn-secondary">사진 링크 추가</button>
            <button type="submit" class="btn btn-primary">저장</button>
        </form>
    </div>
    <script src="admin.js"></script>
    <script>
        let linkCount = 0;

        function addImageLink() {
            if (linkCount >= 10) {
                alert('최대 10개의 사진 링크만 추가할 수 있습니다.');
                return;
            }
            const container = document.getElementById('imageLinks');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label for="imageLink${linkCount}">사진 링크 ${linkCount + 1}:</label>
                <input type="url" id="imageLink${linkCount}" name="imageLink${linkCount}" onblur="validateImageLink(this)">
            `;
            container.appendChild(div);
            linkCount++;
        }

        function validateImageLink(input) {
            const url = input.value;
            fetch(url)
                .then(response => {
                    if (response.ok && response.headers.get('content-type').startsWith('image/')) {
                        input.classList.add('valid-link');
                    } else {
                        input.classList.remove('valid-link');
                    }
                })
                .catch(() => input.classList.remove('valid-link'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('newsletterForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const newsletter = {
                    year: formData.get('year'),
                    month: formData.get('month'),
                    title: formData.get('title'),
                    imageLinks: []
                };
                for (let i = 0; i < linkCount; i++) {
                    const link = formData.get(`imageLink${i}`);
                    if (link) {
                        newsletter.imageLinks.push(link);
                    }
                }
                saveNewsletter(newsletter);
            });

            addImageLink(); // 첫 번째 이미지 링크 입력란 추가

            // URL 파라미터에서 소식지 ID를 가져와 기존 소식지 데이터 로드
            const urlParams = new URLSearchParams(window.location.search);
            const newsletterId = urlParams.get('id');
            if (newsletterId) {
                loadNewsletter(newsletterId).then(data => {
                    form.year.value = data.year;
                    form.month.value = data.month;
                    form.title.value = data.title;
                    data.imageLinks.forEach((link, index) => {
                        if (index > 0) addImageLink();
                        document.getElementById(`imageLink${index}`).value = link;
                        validateImageLink(document.getElementById(`imageLink${index}`));
                    });
                });
            }
        });
    </script>
</body>
</html>
